<html>
<head>
    <title>bitty chat</title>
    <style>
    body {font-family: "Lucida Console", Monaco, monospace; font-size: 14px;}
    input { font-size: 12px; line-height: 14px;}
    textarea {width:500px;height:300px;}
    .container { width: 800px; margin: 40px auto 40px auto;}
    </style>
</head>
<body>
    <div class="container">
    <h1>This is bitty chat</h1>
    <h3>bitty chat is a very small browser-based peer to peer chat app whose source code can be pasted directly into a location bar</h3>
    <p>
        bitty chat uses <a href="http://www.webrtc.org/">WebRTC</a> to create a small, sort-of-secure chat connection between two browsers. It's intended to work kind of like <a href="https://crypto.cat/">CryptoCat</a> originally did. The cool thing is it is small enough that (most of) the source code can be sent directly to the other client, who can paste the source directly in their web browser location bar. If you can send someone either the "URL" or the connection code the web page generates, the other user can connect to you with an encrypted chat session. WebRTC has built in encryption, which we use to secure the conversation itself. We add onto this encryption using the <a href="https://crypto.stanford.edu/sjcl/">Stanford Javascript Crypto Library</a> to ensure that the third party chat connection server won't learn the secret key.
    </p>
    <p>
        There are three main caveats to the security of bitty chat:
    </p>
    <ul>
        <li>The person who receives the chat invitation must trust that the source code or connection code was sent over a secure channel, and that the other party didn't mess with the code somehow.</li>
        <li>You must trust that the <a href="https://crypto.stanford.edu/sjcl/">Stanford Javascript Crypto Library</a> is secure, and that it has been delivered securely to your browser. It's too big to include in the HTML of this page--if we did, the code couldn't be pasted directly into the location bar.</li>
        <li>Javascript doesn't have a secure random number generator, so the keys SJCL uses aren't really secure.</li>
    </ul>
    <p>
        Why, then, did I make bitty chat if it's not really secure? For fun! And it's pretty cool that you can make a small web app that can be contained in a browser's location bar. My ultimate goal is to create something like a BitTorrent magnet link that contains all the requisite data in a URL.
    </p>
    <p>
        Because bitty chat uses WebRTC, an emerging web technology, it currently only works in the <a href="https://www.google.com/intl/en/chrome/browser/">Chrome web browser</a>.
    </p>
    <p>
        Here is <a href="https://github.com/timbauman/bittychat">the code</a>.
    </p>
    <p>
        Here is <a href="client.html">an example</a> that uses my server to broker connections.
    </p>
    <p>
        Here is <a href="data:text/html;,&lt;head&gt;&lt;style&gt;* {font-family: &quot;Lucida Console&quot;, Monaco, monospace; font-size: 14px;}input { font-size: 12px; line-height: 14px;}textarea {width:500px;height:300px;}div, form { display: none; }&lt;/style&gt;  &lt;script src=&quot;https://crypto.stanford.edu/sjcl/sjcl.js&quot;&gt;&lt;/script&gt;&lt;title&gt;bitty chat&lt;/title&gt;&lt;/head&gt;&lt;body&gt;  &lt;div id=&quot;about&quot;&gt;&lt;a href=&quot;http://timbauman.github.io/bittychat/&quot;&gt;about bitty chat&lt;/a&gt;&lt;/div&gt;  &lt;div id=&quot;starting&quot; style=&quot;display: none;&quot;&gt;&lt;button id=&quot;new_button&quot;&gt;new chat&lt;/button&gt; or &lt;input id=&quot;remote_code&quot; type=&quot;text&quot; placeholder=&quot;insert code here&quot;&gt; &lt;button id=&quot;load_button&quot;&gt;load existing chat&lt;/button&gt;&lt;/div&gt;  &lt;div id=&quot;sharing&quot;&gt;    share this URL &lt;input type=&quot;text&quot; disabled=&quot;disabled&quot; id=&quot;url&quot; placeholder=&quot;loading...&quot;&gt;    or this connection code &lt;input type=&quot;text&quot; disabled=&quot;disabled&quot; id=&quot;code&quot; placeholder=&quot;loading...&quot;&gt;&lt;br&gt;  &lt;/div&gt;  &lt;div id=&quot;connecting&quot;&gt;waiting for connection...&lt;/div&gt;  &lt;form id=&quot;chatform&quot;&gt;    message: &lt;input type=&quot;text&quot; id=&quot;message&quot;&gt;&lt;button id=&quot;sendButton&quot; type=&quot;submit&quot; disabled=&quot;&quot;&gt;Send&lt;/button&gt;&lt;br&gt;    &lt;textarea id=&quot;chatbox&quot; disabled=&quot;disabled&quot;&gt;&lt;/textarea&gt;  &lt;/form&gt;  &lt;div id=&quot;closed&quot;&gt;connection lost...&lt;/div&gt;&lt;script&gt;/* config *//* brokers chat connections - untrusted */var URL = 'https://sleepy-refuge-6582.herokuapp.com/';/* stun server */var servers = {  iceServers: [{ 'url': 'stun:stun.l.google.com:19302' }]};/* WebRTC compatability */var RTCPeerConnection = null;var getUserMedia = null;var attachMediaStream = null;var reattachMediaStream = null;var webrtcDetectedBrowser = null;if (navigator.mozGetUserMedia) {  webrtcDetectedBrowser = &quot;firefox&quot;;  RTCPeerConnection = mozRTCPeerConnection;  RTCSessionDescription = mozRTCSessionDescription;  RTCIceCandidate = mozRTCIceCandidate;} else if (navigator.webkitGetUserMedia) {  webrtcDetectedBrowser = &quot;chrome&quot;;  RTCPeerConnection = webkitRTCPeerConnection;  } else {  document.body.innerHTML = &quot;your browser doesn't appear to support WebRTC...&quot;;}performance.now = performance.now || performance.webkitNow;/* the code */var options = {  optional: [{ RtpDataChannels: true }]};var description = null;var cands = [];var sendButton = document.getElementById('sendButton');var form = document.getElementById('chatform');var startDiv = document.getElementById('starting');var sharingDiv = document.getElementById('sharing');var connectingDiv = document.getElementById('connecting');document.getElementById('about').style.display = 'block';var channel;sendButton.disabled = true;var k='';var id='';var d={};var pc1 = new RTCPeerConnection(servers, options);pc1.onicecandidate = function(event) {  if (event.candidate) {    cands.push(event.candidate);  }};channel = pc1.createDataChannel(&quot;sendDataChannel&quot;,                                       {reliable: false});channel.onmessage = onReceiveMessageCallback;channel.onopen = onOpen;channel.onclose = onClose;form.onsubmit = send;if (k === '') {  /* set url*/  startDiv.style.display = 'block';} else {  connectingDiv.style.display = 'block';  receiveOffer(d);}document.getElementById('new_button').onclick = function() {  generateKeys();  pc1.createOffer(createdDesc); /* make offer */  startDiv.style.display = 'none';  sharingDiv.style.display = 'block';};document.getElementById('load_button').onclick = function() {  d = JSON.parse(document.getElementById('remote_code').value);  k = d.k;  id = d.id;  receiveOffer(d.d);};function generateKeys() {  if (!pc1.localDescription) {    /* not sure if this is secure but it keeps shuffling the key until it gets an offer */    k = sjcl.random.randomWords(1,9)[0].toString(); /* not secure */    id = sjcl.random.randomWords(1,9)[0].toString();    setTimeout(generateKeys, 90);  }}function receiveOffer(d) {  console.log(d);  if (d.desc &amp;&amp; d.peers) {    pc1.setRemoteDescription(new RTCSessionDescription(d.desc));    var peers = d.peers;    console.log(peers);    for (var i = 0; i &lt; peers.length; i++) {      var peer = peers[i];      var cand = new RTCIceCandidate(peer);      pc1.addIceCandidate(cand);    }    sharingDiv.style.display = 'none';    startDiv.style.display = 'none';    connectingDiv.style.display = 'block';  }  if (!pc1.localDescription) {    /* we must respond */    pc1.createAnswer(createdDesc);    console.log('responding with answer');  }}function send() {  var msg = document.getElementById('message');  var m = msg.value;  channel.send(m);  console.log(m);  document.getElementById('chatbox').value += 'me: ' + m + '\n';  msg.value = '';  msg.focus();  return false;}function closeDataChannels() {  channel.close();  pc1.close();  pc1 = null;  sendButton.disabled = true;  dataChannelSend.value = &quot;&quot;;  dataChannelReceive.value = &quot;&quot;;}window.onbeforeunload = closeDataChannels;function createdDesc(desc) {  pc1.setLocalDescription(desc);  if (cands.length == 0) {    setTimeout(function() { createdDesc(desc); }, 2000);    return;  }  console.log('description');  var j = JSON.stringify({desc: desc, peers: cands});  console.log(pc1.remoteDescription);  if (pc1.remoteDescription) {    var offer = sjcl.encrypt(k, j + JSON.stringify(sjcl.hash.sha256.hash(j)));    console.log(offer);    sendOffer(offer);  } else {    document.getElementById('url').value = 'data:text/html;,' + document.documentElement.innerHTML.replace(/k='';/, &quot;k='&quot; + k + &quot;';&quot;).replace(/id='';/, &quot;id='&quot; + id + &quot;';&quot;).replace(/d={};/, &quot;d=&quot; + j + &quot;;&quot;);    document.getElementById('code').value = JSON.stringify({k:k,id:id,d:{desc: desc, peers: cands}});    /* begin polling for offers */    listenForOffers();  }}function sendOffer(offer) {  var req = new XMLHttpRequest();  req.open(&quot;get&quot;, URL + '?k=' + encodeURIComponent(id) + '&amp;v=' + encodeURIComponent(offer), true);  req.send();  connectingDiv.style.display = 'block';}function heardOffer(data) {  if (data &amp;&amp; data.trim()) {    var decrypted = sjcl.decrypt(k, data);    hash = JSON.parse(decrypted.substring(decrypted.lastIndexOf('[')));    j = decrypted.substring(0, decrypted.lastIndexOf('['));    if (hash.toString() === sjcl.hash.sha256.hash(j).toString()) {      o = JSON.parse(j);      receiveOffer(o);    }  }}function listenForOffers() {  /* this may take many forms! perhaps in the future we will use something kewler than json */  if (!pc1.remoteDescription) {    connectingDiv.style.display = 'block';    var req = new XMLHttpRequest();    req.onload = function(e) {      heardOffer(req.responseText);    };    req.open(&quot;get&quot;, URL + '?k=' + encodeURIComponent(id), true);    req.send();    setTimeout(listenForOffers, 2000);  }}function receiveChannelCallback(event) {  channel = event.channel;  channel.onmessage = onReceiveMessageCallback;  channel.onopen = onOpen;  channel.onclose = onClose;}function onReceiveMessageCallback(event) {  document.getElementById('chatbox').value += 'them: ' + event.data + '\n';}function onOpen() {  var readyState = channel.readyState;  sendButton.disabled = readyState !== &quot;open&quot;;  if (!sendButton.disabled) {    document.title += ' - ' + id;    form.style.display = 'block';    connectingDiv.style.display = 'none';  }}function onClose() {  form.style.display = 'none';  document.getElementById('closed').style.display = 'block';}&lt;/script&gt;&lt;/body&gt;">a location bar contained version</a>.
</div>
</body>